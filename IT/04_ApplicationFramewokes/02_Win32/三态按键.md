# `1. Win32`

```
#include <windows.h>
#include <Windowsx.h>
#include <Commctrl.h>
#include <assert.h>
#include <atltypes.h>
#include "resource.h"


//给控件加上图片三态功能类
class CTristateData
{
public:
	enum TRISTATAE_STATE {NORMAL, PRESSED, HOVERING};
	TRISTATAE_STATE m_state = NORMAL;

	HDC m_hdcMem{};
	CRect m_rtFactor{};

public:
	CTristateData(HINSTANCE hInst, HWND hWnd, int idBm)
	{
		assert(hInst && hWnd && idBm);

		HDC hdc = GetDC(hWnd);
		assert(hdc);
		m_hdcMem = CreateCompatibleDC(hdc);
		assert(m_hdcMem);

		HBITMAP hbm = LoadBitmap(hInst, MAKEINTRESOURCE(idBm));
		assert(hbm);

		BITMAP bm{};
		GetObject(hbm, sizeof(BITMAP), &bm);

		m_rtFactor.right = bm.bmWidth / 3;
		m_rtFactor.bottom = bm.bmHeight;

		SelectObject(m_hdcMem, hbm);

		DeleteObject(hbm);
		DeleteDC(hdc);
	}

	~CTristateData()
	{
		DeleteDC(m_hdcMem);	
	}
};

HINSTANCE g_hInst{};
DLGPROC g_pOldCloseSttProc{};
CTristateData* g_pTristateData{};
INT_PTR CALLBACK CloseSttProc(HWND hDlg, UINT uMsg, WPARAM wParam, LPARAM lParam);
INT_PTR CALLBACK MainDlgProc(HWND hDlg, UINT uMsg, WPARAM wParam, LPARAM lParam);

int __stdcall WinMain(_In_ HINSTANCE hInstance, _In_opt_ HINSTANCE hPrevInstance, _In_ LPSTR lpCmdLine, _In_ int nShowCmd)
{
	g_hInst = hInstance;
	DialogBox(hInstance, MAKEINTRESOURCE(IDDLG_MAIN), 0, MainDlgProc);
	return 0;
}

INT_PTR CALLBACK CloseSttProc(HWND hDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)
{
	switch (uMsg)
	{
	case WM_LBUTTONDOWN:
		{
			g_pTristateData->m_state = CTristateData::PRESSED;

			InvalidateRect(hDlg, 0, 1);
		}break;
	case WM_LBUTTONUP:
		{
			g_pTristateData->m_state = CTristateData::NORMAL;

			InvalidateRect(hDlg, 0, 1);
		}break;
	case WM_MOUSEMOVE:
		{
			TRACKMOUSEEVENT tme{};
			tme.cbSize = sizeof(TRACKMOUSEEVENT);
			tme.dwFlags = TME_HOVER | TME_LEAVE;
			tme.hwndTrack = hDlg;
			tme.dwHoverTime = 10;
			TrackMouseEvent(&tme);
		}break;
	case WM_MOUSELEAVE:
		{
			g_pTristateData->m_state = CTristateData::NORMAL;

			InvalidateRect(hDlg, 0, 1);
		}break;
	case WM_MOUSEHOVER:
		{
			g_pTristateData->m_state = CTristateData::HOVERING;

			InvalidateRect(hDlg, 0, 1);
		}break;
	case WM_PAINT:
		{
			// 1. 三态数据没有准备好
			if (!g_pTristateData)
				break;

			// 2. 确定绘制源区域 绘制目标区域
			CRect rtBmToDraw = g_pTristateData->m_rtFactor;
			rtBmToDraw.MoveToX(rtBmToDraw.Width() * g_pTristateData->m_state);

			CRect rtClnt{};
			GetClientRect(hDlg, &rtClnt);

			// 3. 绘制
			PAINTSTRUCT ps{};
			HDC hdc = BeginPaint(hDlg, &ps);
			assert(hdc);

			StretchBlt(hdc, 0, 0, rtClnt.right, rtClnt.bottom, g_pTristateData->m_hdcMem, rtBmToDraw.left, rtBmToDraw.top, rtBmToDraw.Width(), rtBmToDraw.Height(), SRCCOPY);

			EndPaint(hDlg, &ps);
		}break;
	case WM_LBUTTONDBLCLK:
		{
			return TRUE;
		}break;
	}

	return g_pOldCloseSttProc(hDlg, uMsg, wParam, lParam);
}

INT_PTR CALLBACK MainDlgProc(HWND hDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)
{
	switch (uMsg)
	{
	case WM_CLOSE:
		EndDialog(hDlg, 0);
		break;
	case WM_INITDIALOG:
		{
			HWND hStt = GetDlgItem(hDlg, IDBTN_2);
			assert(hStt);
			g_pOldCloseSttProc = (DLGPROC)SetWindowLongPtr(hStt, GWLP_WNDPROC, (LONG)CloseSttProc);
			assert(g_pOldCloseSttProc);

			g_pTristateData = new CTristateData(g_hInst, hStt, IDBM_1);
			assert(g_pTristateData);
		}break;
	}

	return FALSE;
}
```

# `2 MFC`

```
#include <windows.h>
#include <Windowsx.h>
#include <Commctrl.h>
#include <assert.h>
#include <atltypes.h>
#include "resource.h"


class CTristateCtrl
{
	//*****************************************************************************************************************
	//Prepare ******************************************************************************************************
	enum TRISTATE_STATE { NORMAL, PRESSED, HOVERING };

	//*****************************************************************************************************************
	//Properties ***************************************************************************************************
public:
protected:
private:
	TRISTATE_STATE m_state; //三态状态
	HDC m_hdcMem{};			//内存dc(画布)
	CRect m_rtBmFactor{};	//位置1/3区域

		//*****************************************************************************************************************
		//Constructor **************************************************************************************************
public:
	CTristateCtrl(HINSTANCE hInst, HWND hWnd, int id);
	~CTristateCtrl();
protected:
private:

	//*****************************************************************************************************************
	//Functions ****************************************************************************************************
public:
	virtual BOOL OnLBtnDown(HWND hDlg, UINT uMsg, WPARAM wParam, LPARAM lParam);
	virtual BOOL OnLBtnUp(HWND hDlg, UINT uMsg, WPARAM wParam, LPARAM lParam);
	virtual BOOL OnMouseMv(HWND hDlg, UINT uMsg, WPARAM wParam, LPARAM lParam);
	virtual BOOL OnMouseLv(HWND hDlg, UINT uMsg, WPARAM wParam, LPARAM lParam);
	virtual BOOL OnMouseHv(HWND hDlg, UINT uMsg, WPARAM wParam, LPARAM lParam);
	virtual BOOL OnPaint(HWND hDlg, UINT uMsg, WPARAM wParam, LPARAM lParam);

protected:
private:

	//*****************************************************************************************************************
	//**************************************************************************************************************
};

HINSTANCE g_hInst{};
CTristateCtrl* g_pTriCtrl{};
INT_PTR CALLBACK MainDlgProc(HWND hDlg, UINT uMsg, WPARAM wParam, LPARAM lParam);

int __stdcall WinMain(_In_ HINSTANCE hInstance, _In_opt_ HINSTANCE hPrevInstance, _In_ LPSTR lpCmdLine, _In_ int nShowCmd)
{
	g_hInst = hInstance;
	DialogBox(hInstance, MAKEINTRESOURCE(IDDLG_MAIN), 0, MainDlgProc);
	return 0;
}


INT_PTR CALLBACK MainDlgProc(HWND hDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)
{
	switch (uMsg)
	{
	case WM_INITDIALOG:
		{
			//DWORD exStyle = GetWindowLong(hDlg, GWL_EXSTYLE);
			//exStyle |= WS_EX_LAYERED;
			//SetWindowLong(hDlg, GWL_EXSTYLE, exStyle);
			//SetLayeredWindowAttributes(hDlg, 0, 0xe0, LWA_ALPHA);

			g_pTriCtrl = new CTristateCtrl(g_hInst, hDlg, IDBM_JIAO_WO_BA_BA);
		}break;
	case WM_LBUTTONDOWN:
		if (g_pTriCtrl->OnLBtnDown(hDlg, uMsg, wParam, lParam))
			return TRUE;
		break;
	case WM_LBUTTONUP:
		if (g_pTriCtrl->OnLBtnUp(hDlg, uMsg, wParam, lParam))
			return TRUE;
		break;
	case WM_MOUSEMOVE:
		if (g_pTriCtrl->OnMouseMv(hDlg, uMsg, wParam, lParam))
			return TRUE;
		break;
	case WM_MOUSEHOVER:
		if (g_pTriCtrl->OnMouseHv(hDlg, uMsg, wParam, lParam))
			return TRUE;
		break;
	case WM_MOUSELEAVE:
		if (g_pTriCtrl->OnMouseLv(hDlg, uMsg, wParam, lParam))
			return TRUE;
		break;
	case WM_PAINT:
		if (g_pTriCtrl->OnPaint(hDlg, uMsg, wParam, lParam))
			return TRUE;
		break;
	case WM_CLOSE:
		EndDialog(hDlg, 0);
		break;
	}

	return FALSE;
}

CTristateCtrl::CTristateCtrl(HINSTANCE hInst, HWND hWnd, int id)
{
	HBITMAP hbm = LoadBitmap(hInst, MAKEINTRESOURCE(id));
	assert(hbm);

	HDC hdcClnt = GetDC(hWnd);
	assert(hdcClnt);
	m_hdcMem = CreateCompatibleDC(hdcClnt);
	assert(m_hdcMem);
	SelectObject(m_hdcMem, hbm);

	BITMAP bm{};
	GetObject(hbm, sizeof(BITMAP), &bm);
	m_rtBmFactor.right = bm.bmWidth / 3;
	m_rtBmFactor.bottom = bm.bmHeight;

	DeleteObject(hdcClnt);
	DeleteObject(hbm);
}

CTristateCtrl::~CTristateCtrl()
{
	if (m_hdcMem)
		DeleteObject(m_hdcMem);
}

BOOL CTristateCtrl::OnLBtnDown(HWND hDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)
{
	m_state = PRESSED;
	InvalidateRect(hDlg, 0, 0);

	return 0;
}

BOOL CTristateCtrl::OnLBtnUp(HWND hDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)
{
	m_state = NORMAL;
	InvalidateRect(hDlg, 0, 0);

	return 0;
}

BOOL CTristateCtrl::OnMouseMv(HWND hDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)
{
	TRACKMOUSEEVENT tme{};
	tme.cbSize = sizeof(TRACKMOUSEEVENT);
	tme.dwFlags = TME_HOVER | TME_LEAVE;
	tme.dwHoverTime = 10;
	tme.hwndTrack = hDlg;
	TrackMouseEvent(&tme);

	return 0;
}

BOOL CTristateCtrl::OnMouseLv(HWND hDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)
{
	m_state = NORMAL;
	InvalidateRect(hDlg, 0, 0);

	return 0;
}

BOOL CTristateCtrl::OnMouseHv(HWND hDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)
{
	m_state = HOVERING;
	InvalidateRect(hDlg, 0, 0);

	return 0;
}

BOOL CTristateCtrl::OnPaint(HWND hDlg, UINT uMsg, WPARAM wParam, LPARAM lParam)
{
	// 得到绘制源的区域  客户区区域
	CRect rtSrc = m_rtBmFactor;
	rtSrc.MoveToX(m_state * m_rtBmFactor.Width());

	static CRect rtClnt{};
	GetClientRect(hDlg, rtClnt);

	//绘制
	PAINTSTRUCT ps{};
	HDC hdc = BeginPaint(hDlg, &ps);
	assert(hdc);
	StretchBlt(hdc, 0, 0, rtClnt.Width(), rtClnt.Height(),
		m_hdcMem, rtSrc.left, rtSrc.top, rtSrc.Width(), rtSrc.Height(), SRCCOPY);
	EndPaint(hDlg, &ps);

	//
	return 0;
}
```

